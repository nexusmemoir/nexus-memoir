<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - AkademikSoru</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon">ğŸ”¬</span>
                <span>AkademikSoru</span>
            </a>
            <nav class="nav">
                <a href="/">Ana Sayfa</a>
                <div class="user-menu">
                    <a href="/profile" class="user-name">ğŸ‘¤ {{ user.display_name }}</a>
                    <a href="/logout" class="btn-logout">Ã‡Ä±kÄ±ÅŸ</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="profile-page">
        <div class="container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar">
                    <span class="avatar-placeholder">{{ user.display_name[0] | upper }}</span>
                </div>
                <div class="profile-info">
                    <h1>{{ user.display_name }}</h1>
                    <span class="profile-username">@{{ user.username }}</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.saved_count }}</div>
                    <div class="stat-label">KayÄ±tlÄ± Soru</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.search_count }}</div>
                    <div class="stat-label">AraÅŸtÄ±rma</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.follow_count }}</div>
                    <div class="stat-label">Takip</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.vote_count }}</div>
                    <div class="stat-label">Oy</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="showTab('saved')">ğŸ“š KayÄ±tlÄ±</button>
                <button class="tab-btn" onclick="showTab('history')">ğŸ• GeÃ§miÅŸ</button>
                <button class="tab-btn" onclick="showTab('topics')">ğŸ·ï¸ Konular</button>
                <button class="tab-btn" onclick="showTab('newsletter')">ğŸ“§ Newsletter</button>
            </div>

            <!-- Saved Questions Tab -->
            <div class="tab-content active" id="tab-saved">
                <h2>KayÄ±tlÄ± Sorular</h2>
                {% if saved_questions %}
                <div class="saved-list">
                    {% for sq in saved_questions %}
                    <div class="saved-item" id="saved-{{ sq.id }}">
                        <div class="saved-info">
                            <div class="saved-question">{{ sq.question }}</div>
                            <div class="saved-meta">
                                <span class="saved-category">{{ sq.category or 'Genel' }}</span>
                                <span>{{ sq.created_at[:10] }}</span>
                            </div>
                        </div>
                        <div class="saved-actions">
                            <button class="btn-view" onclick="viewSaved('{{ sq.question | replace("'", "\\'") }}')">GÃ¶rÃ¼ntÃ¼le</button>
                            <button class="btn-delete" onclick="deleteSaved({{ sq.id }})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>HenÃ¼z kayÄ±tlÄ± soru yok.</p>
                    <a href="/" class="btn-primary">AraÅŸtÄ±rmaya BaÅŸla</a>
                </div>
                {% endif %}
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="tab-history">
                <h2>AraÅŸtÄ±rma GeÃ§miÅŸi</h2>
                {% if search_history %}
                <div class="history-list">
                    {% for h in search_history %}
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-question">{{ h.question }}</div>
                            <div class="history-meta">
                                <span>{{ h.created_at[:10] }}</span>
                            </div>
                        </div>
                        <div class="saved-actions">
                            <button class="btn-search-again" onclick="searchAgain('{{ h.question | replace("'", "\\'") }}')">Tekrar Ara</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>HenÃ¼z araÅŸtÄ±rma geÃ§miÅŸi yok.</p>
                    <a href="/" class="btn-primary">Ä°lk AraÅŸtÄ±rmanÄ± Yap</a>
                </div>
                {% endif %}
            </div>

            <!-- Topics Tab -->
            <div class="tab-content" id="tab-topics">
                <h2>KonularÄ±m</h2>
                <div class="topics-grid">
                    {% for cat in categories %}
                    <div class="topic-card {% if cat.name in followed_topics %}following{% endif %}" id="topic-{{ cat.name }}">
                        <span class="topic-icon">{{ cat.icon }}</span>
                        <span class="topic-name">{{ cat.name }}</span>
                        <button class="btn-follow" onclick="toggleFollow('{{ cat.name }}')">
                            {% if cat.name in followed_topics %}Takipten Ã‡Ä±k{% else %}Takip Et{% endif %}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Newsletter Tab -->
            <div class="tab-content" id="tab-newsletter">
                <h2>Newsletter AboneliÄŸi</h2>
                <div class="newsletter-card">
                    <h3>ğŸ“¬ HaftalÄ±k Bilim BÃ¼lteni</h3>
                    <p>Takip ettiÄŸiniz konulardaki yeni akademik bulgularÄ± e-posta ile alÄ±n.</p>
                    <form id="newsletterForm" class="newsletter-form">
                        <div class="form-group">
                            <label>E-posta Adresi</label>
                            <input type="email" id="newsletterEmail" value="{{ user.email }}" placeholder="email@ornek.com">
                        </div>
                        <div class="form-group">
                            <label>GÃ¶nderim SÄ±klÄ±ÄŸÄ±</label>
                            <div class="frequency-options">
                                <label class="frequency-option">
                                    <input type="radio" name="frequency" value="daily">
                                    <span>GÃ¼nlÃ¼k</span>
                                </label>
                                <label class="frequency-option">
                                    <input type="radio" name="frequency" value="weekly" checked>
                                    <span>HaftalÄ±k</span>
                                </label>
                                <label class="frequency-option">
                                    <input type="radio" name="frequency" value="monthly">
                                    <span>AylÄ±k</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn-subscribe">Abone Ol</button>
                    </form>
                    <div id="newsletterMessage"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Â© 2025 AkademikSoru - Bilimsel AraÅŸtÄ±rma Platformu</p>
        </div>
    </footer>

    <script>
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function viewSaved(question) {
            const params = new URLSearchParams({ q: question, level: 'medium' });
            window.location.href = '/result?' + params.toString();
        }

        function searchAgain(question) {
            const params = new URLSearchParams({ q: question, level: 'medium' });
            window.location.href = '/result?' + params.toString();
        }

        async function deleteSaved(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/questions/save/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.getElementById('saved-' + id).remove();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function toggleFollow(category) {
            const card = document.getElementById('topic-' + category);
            const isFollowing = card.classList.contains('following');
            const endpoint = isFollowing ? '/api/topics/unfollow' : '/api/topics/follow';
            
            const formData = new FormData();
            formData.append('category', category);
            
            try {
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                if (response.ok) {
                    card.classList.toggle('following');
                    const btn = card.querySelector('.btn-follow');
                    btn.textContent = isFollowing ? 'Takip Et' : 'Takipten Ã‡Ä±k';
                }
            } catch (e) {
                console.error(e);
            }
        }

        document.getElementById('newsletterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('newsletterEmail').value;
            const frequency = document.querySelector('input[name="frequency"]:checked').value;
            
            const formData = new FormData();
            formData.append('email', email);
            formData.append('frequency', frequency);
            
            try {
                const response = await fetch('/api/newsletter/subscribe', { method: 'POST', body: formData });
                const data = await response.json();
                
                const msgDiv = document.getElementById('newsletterMessage');
                if (data.success) {
                    msgDiv.innerHTML = '<div class="message success">âœ“ Abonelik baÅŸarÄ±lÄ±!</div>';
                } else {
                    msgDiv.innerHTML = '<div class="message error">' + (data.error || 'Bir hata oluÅŸtu') + '</div>';
                }
            } catch (e) {
                console.error(e);
            }
        });
    </script>
</body>
</html>
