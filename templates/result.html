<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AraÅŸtÄ±rma SonuÃ§larÄ± - AkademikSoru</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon">ğŸ”¬</span>
                <span>AkademikSoru</span>
            </a>
            <nav class="nav">
                <a href="/" class="btn-new-search">+ Yeni AraÅŸtÄ±rma</a>
                {% if user %}
                <div class="user-menu">
                    <a href="/profile" class="user-name">ğŸ‘¤ {{ user.display_name }}</a>
                    <a href="/logout" class="btn-logout">Ã‡Ä±kÄ±ÅŸ</a>
                </div>
                {% else %}
                <a href="/login" class="btn-login">GiriÅŸ Yap</a>
                <a href="/register" class="btn-register">KayÄ±t Ol</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="result-page">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="loading-spinner"></div>
                <p class="loading-text">Akademik makaleler taranÄ±yor...</p>
                <div class="loading-steps">
                    <div class="step active" id="step1">ğŸ” Arama sorgularÄ± oluÅŸturuluyor</div>
                    <div class="step" id="step2">ğŸ“š Makaleler taranÄ±yor</div>
                    <div class="step" id="step3">ğŸ¤– AI ile analiz ediliyor</div>
                    <div class="step" id="step4">ğŸ“ TÃ¼rkÃ§e Ã¶zet hazÄ±rlanÄ±yor</div>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display:none;">
                <span class="error-icon">âŒ</span>
                <p id="errorMessage">Bir hata oluÅŸtu</p>
                <button class="btn-retry" onclick="location.reload()">Tekrar Dene</button>
            </div>

            <!-- Results -->
            <div id="resultsContainer" style="display:none;">
                <!-- Claim Box -->
                <div class="claim-box">
                    <div class="claim-label">AraÅŸtÄ±rÄ±lan Soru</div>
                    <h1 class="claim-text" id="questionText"></h1>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="vote-buttons">
                        <button class="vote-btn up" id="upvoteBtn" onclick="vote('up')">
                            <span>ğŸ‘</span>
                            <span class="vote-count" id="upvoteCount">0</span>
                        </button>
                        <button class="vote-btn down" id="downvoteBtn" onclick="vote('down')">
                            <span>ğŸ‘</span>
                            <span class="vote-count" id="downvoteCount">0</span>
                        </button>
                    </div>
                    <button class="save-btn" id="saveBtn" onclick="toggleSave()">
                        <span>ğŸ”–</span>
                        <span id="saveText">Kaydet</span>
                    </button>
                    <button class="share-btn" onclick="shareResult()">
                        <span>ğŸ“¤</span>
                        <span>PaylaÅŸ</span>
                    </button>
                </div>

                <!-- Evidence Strength -->
                <div class="evidence-strength-box">
                    <div class="evidence-label">KanÄ±t GÃ¼cÃ¼</div>
                    <div class="evidence-badge-large" id="evidenceBadge"></div>
                    <p class="evidence-description" id="evidenceDesc"></p>
                </div>

                <!-- Summary -->
                <div class="summary-section">
                    <div class="summary-header">
                        <span>ğŸ“‹</span>
                        <h2>Ã–zet</h2>
                    </div>
                    <div class="summary-text" id="summaryText"></div>
                </div>

                <!-- Papers - FAZ 3 Derin Analiz -->
                <div class="papers-section">
                    <h2>ğŸ“š Kaynak Makaleler (<span id="paperCount">0</span>)</h2>
                    <div id="papersContainer"></div>
                </div>

                <!-- Related Questions -->
                <div class="related-section">
                    <h2>ğŸ”— Ä°lgili Sorular</h2>
                    <div class="related-grid" id="relatedGrid"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Â© 2025 AkademikSoru - Bilimsel AraÅŸtÄ±rma Platformu</p>
        </div>
    </footer>

    <script>
        let currentResult = null;
        let questionHash = '';
        let isSaved = false;

        // Get URL params
        const params = new URLSearchParams(window.location.search);
        const question = params.get('q');
        const level = params.get('level') || 'medium';

        if (!question) {
            window.location.href = '/';
        }

        // Start research
        async function startResearch() {
            const loadingSteps = ['step1', 'step2', 'step3', 'step4'];
            let currentStep = 0;

            const stepInterval = setInterval(() => {
                if (currentStep < loadingSteps.length - 1) {
                    document.getElementById(loadingSteps[currentStep]).classList.remove('active');
                    document.getElementById(loadingSteps[currentStep]).classList.add('done');
                    currentStep++;
                    document.getElementById(loadingSteps[currentStep]).classList.add('active');
                }
            }, 2000);

            try {
                const formData = new FormData();
                formData.append('question', question);
                formData.append('level', level);

                const response = await fetch('/api/research', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(stepInterval);

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'AraÅŸtÄ±rma baÅŸarÄ±sÄ±z');
                }

                currentResult = await response.json();
                questionHash = currentResult.question_hash;
                displayResults(currentResult);

                // Get vote counts
                loadVotes();

            } catch (error) {
                clearInterval(stepInterval);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'flex';
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        function displayResults(data) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            document.getElementById('questionText').textContent = data.question;

            // Evidence badge
            const badge = document.getElementById('evidenceBadge');
            const strength = data.evidence_strength;
            badge.className = 'evidence-badge-large ' + strength;
            const labels = { strong: 'âœ“ GÃ¼Ã§lÃ¼ KanÄ±t', moderate: 'â— Orta DÃ¼zey KanÄ±t', limited: 'â—‹ SÄ±nÄ±rlÄ± KanÄ±t', insufficient: 'âŠ˜ Yetersiz KanÄ±t' };
            badge.textContent = labels[strength] || labels.moderate;
            document.getElementById('evidenceDesc').textContent = data.evidence_description;

            // Summary
            document.getElementById('summaryText').innerHTML = data.summary.replace(/\n/g, '<br>');

            // Papers with FAZ 3 deep analysis
            const papersContainer = document.getElementById('papersContainer');
            document.getElementById('paperCount').textContent = data.papers.length;
            
            papersContainer.innerHTML = data.papers.map((p, idx) => `
                <div class="paper-card" id="paper-${idx}">
                    <div class="paper-header">
                        <h3 class="paper-title">${p.title}</h3>
                    </div>
                    <div class="paper-meta">
                        <span>ğŸ“… ${p.year || 'YÄ±l belirtilmemiÅŸ'}</span>
                        <span>ğŸ“Š ${p.citations} atÄ±f</span>
                        <span>ğŸ‘¤ ${p.authors || 'Yazar belirtilmemiÅŸ'}</span>
                    </div>
                    <p class="paper-abstract">${p.abstract ? (p.abstract.length > 300 ? p.abstract.substring(0, 300) + '...' : p.abstract) : 'Ã–zet bulunmuyor'}</p>
                    <div class="paper-actions">
                        <button class="btn-analyze" onclick="analyzePaper(${idx})" id="analyzeBtn-${idx}">
                            ğŸ”¬ Derinlemesine Analiz Et
                        </button>
                        ${p.url ? `<a href="${p.url}" target="_blank" class="btn-analyze" style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-secondary);">ğŸ“„ Makaleyi GÃ¶rÃ¼ntÃ¼le</a>` : ''}
                    </div>
                    <div class="paper-analysis" id="analysis-${idx}" style="display:none;"></div>
                </div>
            `).join('');

            // Related questions
            const relatedGrid = document.getElementById('relatedGrid');
            relatedGrid.innerHTML = (data.related_questions || []).map(q => `
                <div class="related-card" onclick="searchRelated('${q.replace(/'/g, "\\'")}')">
                    <h3>${q}</h3>
                </div>
            `).join('');
        }

        // FAZ 3: Derin Makale Analizi
        async function analyzePaper(idx) {
            const paper = currentResult.papers[idx];
            const btn = document.getElementById(`analyzeBtn-${idx}`);
            const analysisDiv = document.getElementById(`analysis-${idx}`);

            btn.classList.add('loading');
            btn.innerHTML = '<span class="spinner"></span> Analiz ediliyor...';

            try {
                const formData = new FormData();
                formData.append('paper_id', paper.id);
                formData.append('paper_title', paper.title);
                formData.append('paper_abstract', paper.abstract || '');
                formData.append('question', currentResult.question);

                const response = await fetch('/api/paper/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.analysis) {
                    const a = data.analysis;
                    analysisDiv.innerHTML = `
                        <div class="analysis-section">
                            <h4 class="analysis-title">ğŸ¯ Ana Bulgu</h4>
                            <div class="key-finding">
                                <p class="key-finding-text">${a.main_finding}</p>
                            </div>
                        </div>

                        ${a.key_insights && a.key_insights.length > 0 ? `
                        <div class="analysis-section">
                            <h4 class="analysis-title">ğŸ’¡ Ã–nemli Noktalar (TÃ¼rkÃ§e Ã‡eviri)</h4>
                            ${a.key_insights.map((insight, i) => `
                                <div class="key-finding">
                                    <p class="key-finding-text">${insight.turkish}</p>
                                    <p class="key-finding-original">
                                        <strong>Orijinal:</strong> "${insight.original}"
                                    </p>
                                    ${insight.explanation ? `<p class="key-finding-text" style="margin-top:10px;color:var(--accent-cyan);">ğŸ’¬ ${insight.explanation}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        ${a.methodology_note ? `
                        <div class="analysis-section">
                            <h4 class="analysis-title">ğŸ”¬ AraÅŸtÄ±rma YÃ¶ntemi</h4>
                            <p style="color:var(--text-secondary)">${a.methodology_note}</p>
                        </div>
                        ` : ''}

                        ${a.practical_takeaway ? `
                        <div class="analysis-section">
                            <h4 class="analysis-title">âœ… Pratik SonuÃ§</h4>
                            <div class="key-finding" style="border-left-color: var(--accent-green);">
                                <p class="key-finding-text">${a.practical_takeaway}</p>
                            </div>
                        </div>
                        ` : ''}

                        <div class="relevance-meter">
                            <div class="relevance-label">Soruyla Ä°lgililik: %${a.relevance_score}</div>
                            <div class="relevance-bar">
                                <div class="relevance-fill" style="width: ${a.relevance_score}%"></div>
                            </div>
                        </div>
                    `;
                    analysisDiv.style.display = 'block';
                    btn.innerHTML = 'âœ“ Analiz TamamlandÄ±';
                    btn.disabled = true;
                } else {
                    throw new Error('Analiz yapÄ±lamadÄ±');
                }
            } catch (error) {
                btn.classList.remove('loading');
                btn.innerHTML = 'âŒ Hata - Tekrar Dene';
                console.error(error);
            }
        }

        async function loadVotes() {
            try {
                const response = await fetch(`/api/vote/${questionHash}`);
                const data = await response.json();
                document.getElementById('upvoteCount').textContent = data.upvotes;
                document.getElementById('downvoteCount').textContent = data.downvotes;
                if (data.user_vote === 'up') {
                    document.getElementById('upvoteBtn').classList.add('active');
                } else if (data.user_vote === 'down') {
                    document.getElementById('downvoteBtn').classList.add('active');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function vote(type) {
            const formData = new FormData();
            formData.append('question_hash', questionHash);
            formData.append('vote_type', type);

            try {
                const response = await fetch('/api/vote', { method: 'POST', body: formData });
                const data = await response.json();
                document.getElementById('upvoteCount').textContent = data.upvotes;
                document.getElementById('downvoteCount').textContent = data.downvotes;
                
                document.getElementById('upvoteBtn').classList.remove('active');
                document.getElementById('downvoteBtn').classList.remove('active');
                if (data.user_vote === 'up') {
                    document.getElementById('upvoteBtn').classList.add('active');
                } else if (data.user_vote === 'down') {
                    document.getElementById('downvoteBtn').classList.add('active');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function toggleSave() {
            if (isSaved) return;

            const formData = new FormData();
            formData.append('question', currentResult.question);
            formData.append('category', currentResult.category);
            formData.append('result_data', JSON.stringify(currentResult));

            try {
                const response = await fetch('/api/questions/save', { method: 'POST', body: formData });
                if (response.ok) {
                    isSaved = true;
                    document.getElementById('saveBtn').classList.add('saved');
                    document.getElementById('saveText').textContent = 'Kaydedildi';
                } else if (response.status === 401) {
                    window.location.href = '/login';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function shareResult() {
            if (navigator.share) {
                navigator.share({
                    title: currentResult.question,
                    text: `AkademikSoru araÅŸtÄ±rma sonucu: ${currentResult.question}`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link kopyalandÄ±!');
            }
        }

        function searchRelated(q) {
            const params = new URLSearchParams({ q: q, level: level });
            window.location.href = '/result?' + params.toString();
        }

        // Start
        startResearch();
    </script>
</body>
</html>
