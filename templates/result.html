<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AraÅŸtÄ±rma SonuÃ§larÄ± - AkademikSoru</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-icon">ğŸ”¬</span>
                <span class="logo-text">AkademikSoru</span>
            </a>
            <nav class="nav">
                <a href="/" class="btn-new-search">+ Yeni Soru</a>
                {% if user %}
                <a href="/profile" class="user-name">ğŸ‘¤ {{ user.display_name or user.username }}</a>
                {% else %}
                <a href="/login" class="btn-login">GiriÅŸ Yap</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="result-page">
        <div class="container">
            
            <div class="claim-box">
                <div class="claim-label">AraÅŸtÄ±rÄ±lan Soru</div>
                <h1 id="questionTitle" class="claim-text">YÃ¼kleniyor...</h1>
            </div>

            <!-- FAZ 2: Oylama ve Kaydetme -->
            <div class="action-bar">
                <div class="vote-buttons">
                    <button class="vote-btn up" id="voteUp" onclick="vote('up')">
                        ğŸ‘ <span id="upvoteCount">0</span>
                    </button>
                    <button class="vote-btn down" id="voteDown" onclick="vote('down')">
                        ğŸ‘ <span id="downvoteCount">0</span>
                    </button>
                </div>
                <button class="save-btn" id="saveBtn" onclick="saveQuestion()">
                    ğŸ“Œ <span id="saveText">Kaydet</span>
                </button>
                <button class="share-btn" onclick="shareResult()">
                    ğŸ“¤ PaylaÅŸ
                </button>
            </div>

            <!-- FAZ 1: KanÄ±t GÃ¼cÃ¼ GÃ¶stergesi -->
            <div id="evidenceStrength" class="evidence-strength-box">
                <div class="evidence-label">KanÄ±t GÃ¼cÃ¼</div>
                <div id="evidenceBadge" class="evidence-badge-large"></div>
                <p id="evidenceDescription" class="evidence-description"></p>
            </div>

            <section class="summary-section">
                <div class="summary-header">
                    <h2>ğŸ“‹ Bilimsel Ã–zet</h2>
                    <div id="explanationLevel" class="explanation-level-indicator"></div>
                </div>
                <div id="summaryText" class="summary-content">
                    YÃ¼kleniyor...
                </div>
                
                <div id="consensusBox" class="consensus-box" style="display: none;">
                    <strong>ğŸ¯ Bilimsel KonsensÃ¼s:</strong>
                    <p id="consensusText"></p>
                </div>
            </section>

            <section class="findings-section">
                <h2>ğŸ” Ana Bulgular</h2>
                <div id="keyFindingsList" class="findings-list"></div>
            </section>

            <div id="conflictsSection" class="conflicts-section" style="display: none;">
                <h2>âš–ï¸ Ã‡eliÅŸkili GÃ¶rÃ¼ÅŸler</h2>
                <div id="conflictsList" class="conflicts-list"></div>
            </div>

            <!-- FAZ 1: Ä°lgili Sorular -->
            <section id="relatedQuestionsSection" class="related-questions-section" style="display: none;">
                <h2>ğŸ’¡ Bunu da Merak Edebilirsiniz</h2>
                <div id="relatedQuestionsList" class="related-questions-grid"></div>
            </section>

            <div class="tabs">
                <button class="tab active" data-tab="all">
                    ğŸ“š TÃ¼m Makaleler <span id="allCount" class="count">0</span>
                </button>
                <button class="tab" data-tab="recent">
                    ğŸ†• Son 5 YÄ±l <span id="recentCount" class="count">0</span>
                </button>
                <button class="tab" data-tab="cited">
                    â­ Ã‡ok AtÄ±f Alan <span id="citedCount" class="count">0</span>
                </button>
            </div>

            <div id="allTab" class="tab-content active">
                <div id="allPapers" class="sources-grid"></div>
            </div>

            <div id="recentTab" class="tab-content">
                <div id="recentPapers" class="sources-grid"></div>
            </div>

            <div id="citedTab" class="tab-content">
                <div id="citedPapers" class="sources-grid"></div>
            </div>

            <section class="metadata-section">
                <div class="metadata-grid">
                    <div class="metadata-card">
                        <h3>ğŸ·ï¸ Bilimsel Terimler</h3>
                        <div id="termsList" class="tags-list"></div>
                    </div>
                    <div class="metadata-card">
                        <h3>ğŸ”¬ AraÅŸtÄ±rma AlanlarÄ±</h3>
                        <div id="areasList" class="tags-list"></div>
                    </div>
                </div>
            </section>

            <div id="gapsSection" class="gaps-section" style="display: none;">
                <h3>ğŸ“Œ AraÅŸtÄ±rma BoÅŸluklarÄ±</h3>
                <ul id="gapsList"></ul>
            </div>

            <section class="stats-section">
                <h3>ğŸ“Š AraÅŸtÄ±rma Ä°statistikleri</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="statTotal">0</span>
                        <span class="stat-label">Toplam Makale</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statRecent">0</span>
                        <span class="stat-label">2020+ YayÄ±n</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statCited">0</span>
                        <span class="stat-label">YÃ¼ksek AtÄ±f</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statOpen">0</span>
                        <span class="stat-label">AÃ§Ä±k EriÅŸim</span>
                    </div>
                </div>
                <div id="qualityNote" class="quality-note"></div>
            </section>

            <!-- FAZ 1: Sosyal PaylaÅŸÄ±m -->
            <section class="share-section">
                <h3>ğŸ“± PaylaÅŸ</h3>
                <div class="share-buttons">
                    <button class="share-btn twitter" onclick="shareOnTwitter()">
                        <span>ğŸ¦</span> Twitter
                    </button>
                    <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                        <span>ğŸ’¬</span> WhatsApp
                    </button>
                    <button class="share-btn copy" onclick="copyLink()">
                        <span>ğŸ”—</span> Linki Kopyala
                    </button>
                </div>
            </section>

            <div class="disclaimer result-disclaimer">
                <p id="disclaimerText">
                    <strong>âš ï¸ Ã–nemli:</strong> Bu bir bilimsel literatÃ¼r Ã¶zetidir. 
                    TÄ±bbi/kiÅŸisel tavsiye deÄŸildir. SaÄŸlÄ±k kararlarÄ±nÄ±z iÃ§in mutlaka uzmanÄ±nÄ±za danÄ±ÅŸÄ±n.
                </p>
            </div>

            <div class="new-search-box">
                <a href="/" class="btn-search">ğŸ” Yeni Soru Sor</a>
            </div>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Â© 2026 AkademikSoru - Bilimsel LiteratÃ¼r AraÅŸtÄ±rma</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultData = sessionStorage.getItem('researchResult');
            
            if (!resultData) {
                window.location.href = '/';
                return;
            }

            const data = JSON.parse(resultData);
            renderResults(data);
        });

        function renderResults(data) {
            document.getElementById('questionTitle').textContent = 
                data.normalized_question || sessionStorage.getItem('originalQuestion');

            const synthesis = data.synthesis || {};

            // FAZ 1: KanÄ±t GÃ¼cÃ¼
            renderEvidenceStrength(data.evidence_strength);

            // FAZ 1: AnlatÄ±m Seviyesi GÃ¶stergesi
            renderExplanationLevel(data.explanation_level);

            // Summary
            document.getElementById('summaryText').textContent = 
                synthesis.summary || 'Ã–zet oluÅŸturulamadÄ±.';

            // Consensus
            if (synthesis.consensus) {
                document.getElementById('consensusBox').style.display = 'block';
                document.getElementById('consensusText').textContent = synthesis.consensus;
            }

            // Key Findings
            renderList(synthesis.key_findings || [], 'keyFindingsList', 'finding-item');

            // Conflicts
            if (synthesis.conflicting_views && synthesis.conflicting_views.length > 0) {
                document.getElementById('conflictsSection').style.display = 'block';
                renderList(synthesis.conflicting_views, 'conflictsList', 'conflict-item');
            }

            // FAZ 1: Ä°lgili Sorular
            if (data.related_questions && data.related_questions.length > 0) {
                document.getElementById('relatedQuestionsSection').style.display = 'block';
                renderRelatedQuestions(data.related_questions);
            }

            // Research Gaps
            if (synthesis.research_gaps && synthesis.research_gaps.length > 0) {
                document.getElementById('gapsSection').style.display = 'block';
                renderList(synthesis.research_gaps, 'gapsList', 'gap-item', true);
            }

            // Papers
            renderPapers(data.papers || [], 'allPapers');
            renderPapers(data.recent_papers || [], 'recentPapers');
            renderPapers(data.highly_cited || [], 'citedPapers');

            // Counts
            document.getElementById('allCount').textContent = (data.papers || []).length;
            document.getElementById('recentCount').textContent = (data.recent_papers || []).length;
            document.getElementById('citedCount').textContent = (data.highly_cited || []).length;

            // Metadata
            renderTags(data.scientific_terms || [], 'termsList');
            renderTags(data.research_areas || [], 'areasList');

            // Stats
            const stats = data.stats || {};
            document.getElementById('statTotal').textContent = stats.total_papers || 0;
            document.getElementById('statRecent').textContent = stats.recent_count || 0;
            document.getElementById('statCited').textContent = stats.highly_cited_count || 0;
            document.getElementById('statOpen').textContent = stats.open_access_count || 0;

            // Quality Note
            if (synthesis.quality_note) {
                document.getElementById('qualityNote').innerHTML = 
                    `<strong>ğŸ“Œ Kalite Notu:</strong> ${synthesis.quality_note}`;
            }

            // Disclaimer
            if (synthesis.disclaimer) {
                document.getElementById('disclaimerText').innerHTML = 
                    `<strong>âš ï¸ Ã–nemli:</strong> ${synthesis.disclaimer}`;
            }

            setupTabs();
        }

        // FAZ 1: KanÄ±t GÃ¼cÃ¼ Render
        function renderEvidenceStrength(strength) {
            const badge = document.getElementById('evidenceBadge');
            const description = document.getElementById('evidenceDescription');

            const levels = {
                'strong': {
                    icon: 'ğŸŸ¢',
                    text: 'GÃ¼Ã§lÃ¼ KanÄ±t',
                    desc: 'Ã‡ok sayÄ±da yÃ¼ksek kaliteli Ã§alÄ±ÅŸma, meta-analizler mevcut. Bulgular tutarlÄ±.',
                    class: 'evidence-strong'
                },
                'moderate': {
                    icon: 'ğŸŸ¡',
                    text: 'Orta Seviye KanÄ±t',
                    desc: 'SÄ±nÄ±rlÄ± sayÄ±da Ã§alÄ±ÅŸma var. BazÄ± Ã§eliÅŸkili bulgular olabilir.',
                    class: 'evidence-moderate'
                },
                'limited': {
                    icon: 'ğŸŸ ',
                    text: 'SÄ±nÄ±rlÄ± KanÄ±t',
                    desc: 'Az sayÄ±da Ã§alÄ±ÅŸma. Daha fazla araÅŸtÄ±rma gerekli.',
                    class: 'evidence-limited'
                },
                'insufficient': {
                    icon: 'ğŸ”´',
                    text: 'Yetersiz Veri',
                    desc: 'Yeterli akademik Ã§alÄ±ÅŸma bulunamadÄ±.',
                    class: 'evidence-insufficient'
                }
            };

            const level = levels[strength] || levels['insufficient'];
            
            badge.innerHTML = `<span class="${level.class}">${level.icon} ${level.text}</span>`;
            description.textContent = level.desc;
        }

        // FAZ 1: AnlatÄ±m Seviyesi GÃ¶stergesi
        function renderExplanationLevel(level) {
            const indicator = document.getElementById('explanationLevel');
            
            const levels = {
                'simple': { icon: 'ğŸ§’', text: 'Basit AnlatÄ±m' },
                'medium': { icon: 'ğŸ§‘', text: 'Orta Seviye' },
                'academic': { icon: 'ğŸ“', text: 'Akademik Dil' }
            };

            const l = levels[level] || levels['medium'];
            indicator.innerHTML = `<span class="level-indicator">${l.icon} ${l.text}</span>`;
        }

        // FAZ 1: Ä°lgili Sorular
        function renderRelatedQuestions(questions) {
            const container = document.getElementById('relatedQuestionsList');
            
            let html = '';
            questions.forEach(q => {
                html += `
                    <div class="related-question-card" onclick="askRelatedQuestion('${escapeHtml(q.question)}')">
                        <span class="related-icon">${q.icon}</span>
                        <h4>${escapeHtml(q.question)}</h4>
                        <span class="related-action">AraÅŸtÄ±r â†’</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function askRelatedQuestion(question) {
            sessionStorage.setItem('prefillQuestion', question);
            window.location.href = '/';
        }

        function renderList(items, containerId, className, isUl = false) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="empty-state">-</p>';
                return;
            }

            let html = '';
            items.forEach(item => {
                if (isUl) {
                    html += `<li class="${className}">${escapeHtml(item)}</li>`;
                } else {
                    html += `<div class="${className}">âœ“ ${escapeHtml(item)}</div>`;
                }
            });

            container.innerHTML = html;
        }

        function renderPapers(papers, containerId) {
            const container = document.getElementById(containerId);
            
            if (!papers || papers.length === 0) {
                container.innerHTML = '<p class="empty-state">Makale bulunamadÄ±.</p>';
                return;
            }

            let html = '';
            papers.forEach((paper, index) => {
                const year = paper.year || 'N/A';
                const citations = paper.citations || 0;
                const openAccess = paper.open_access ? 'ğŸ”“ AÃ§Ä±k EriÅŸim' : '';
                const pdfLink = paper.pdf_url ? 
                    `<a href="${paper.pdf_url}" target="_blank" class="pdf-link">ğŸ“„ PDF</a>` : '';

                html += `
                    <div class="source-card paper-card">
                        <div class="source-index">${index + 1}</div>
                        <div class="source-content">
                            <h4 class="source-title">${escapeHtml(paper.title)}</h4>
                            <div class="source-meta">
                                <span class="source-authors">${escapeHtml(paper.authors)}</span>
                                <span class="source-year">${year}</span>
                            </div>
                            ${paper.venue ? `<div class="source-venue">${escapeHtml(paper.venue)}</div>` : ''}
                            <div class="paper-stats">
                                <span class="citation-count">ğŸ“Š ${citations} atÄ±f</span>
                                ${openAccess ? `<span class="open-access">${openAccess}</span>` : ''}
                            </div>
                            ${paper.abstract ? `<div class="paper-abstract">${escapeHtml(paper.abstract)}</div>` : ''}
                            <div class="paper-actions">
                                <a href="${paper.url}" target="_blank" rel="noopener" class="paper-link">
                                    Makaleyi GÃ¶rÃ¼ntÃ¼le â†’
                                </a>
                                ${pdfLink}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderTags(tags, containerId) {
            const container = document.getElementById(containerId);
            
            if (!tags || tags.length === 0) {
                container.innerHTML = '<span class="empty-state">-</span>';
                return;
            }

            let html = '';
            tags.forEach(tag => {
                html += `<span class="keyword-tag">${escapeHtml(tag)}</span>`;
            });

            container.innerHTML = html;
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    document.getElementById(tabName + 'Tab').classList.add('active');
                });
            });
        }

        // FAZ 1: PaylaÅŸÄ±m FonksiyonlarÄ±
        function shareOnTwitter() {
            const question = sessionStorage.getItem('originalQuestion');
            const text = `"${question}" sorusunun bilimsel yanÄ±tÄ±nÄ± @AkademikSoru'da buldum!`;
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function shareOnWhatsApp() {
            const question = sessionStorage.getItem('originalQuestion');
            const text = `"${question}" sorusunun bilimsel yanÄ±tÄ±nÄ± buldum: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link kopyalandÄ±!');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // FAZ 2: Oylama ve Kaydetme
        let questionHash = null;
        let isSaved = false;

        async function initVotesAndSave() {
            const data = JSON.parse(sessionStorage.getItem('researchResult'));
            if (data && data.question_hash) {
                questionHash = data.question_hash;
                isSaved = data.is_saved || false;
                updateSaveButton();
                
                // Oy bilgisini al
                try {
                    const r = await fetch(`/api/vote/${questionHash}`);
                    const votes = await r.json();
                    document.getElementById('upvoteCount').textContent = votes.upvotes || 0;
                    document.getElementById('downvoteCount').textContent = votes.downvotes || 0;
                    if (votes.user_vote === 'up') {
                        document.getElementById('voteUp').classList.add('active');
                    } else if (votes.user_vote === 'down') {
                        document.getElementById('voteDown').classList.add('active');
                    }
                } catch (e) {}
            }
        }

        async function vote(type) {
            if (!questionHash) return;
            const formData = new FormData();
            formData.append('question_hash', questionHash);
            formData.append('vote_type', type);
            
            try {
                const r = await fetch('/api/vote', {method: 'POST', body: formData});
                const data = await r.json();
                if (data.success) {
                    document.getElementById('upvoteCount').textContent = data.upvotes;
                    document.getElementById('downvoteCount').textContent = data.downvotes;
                    
                    document.getElementById('voteUp').classList.remove('active');
                    document.getElementById('voteDown').classList.remove('active');
                    if (data.action !== 'removed') {
                        document.getElementById('vote' + (type === 'up' ? 'Up' : 'Down')).classList.add('active');
                    }
                }
            } catch (e) {}
        }

        async function saveQuestion() {
            const question = sessionStorage.getItem('originalQuestion');
            if (!question) return;
            
            if (isSaved) {
                alert('Bu soru zaten kayÄ±tlÄ±.');
                return;
            }
            
            const formData = new FormData();
            formData.append('question', question);
            
            try {
                const r = await fetch('/api/questions/save', {method: 'POST', body: formData});
                const data = await r.json();
                if (r.ok) {
                    isSaved = true;
                    updateSaveButton();
                } else {
                    alert(data.error || 'Kaydetme baÅŸarÄ±sÄ±z. GiriÅŸ yapmÄ±ÅŸ olmanÄ±z gerekiyor.');
                }
            } catch (e) {
                alert('Bir hata oluÅŸtu.');
            }
        }

        function updateSaveButton() {
            const btn = document.getElementById('saveBtn');
            const text = document.getElementById('saveText');
            if (isSaved) {
                btn.classList.add('saved');
                text.textContent = 'KayÄ±tlÄ±';
            } else {
                btn.classList.remove('saved');
                text.textContent = 'Kaydet';
            }
        }

        function shareResult() {
            const question = sessionStorage.getItem('originalQuestion');
            const text = `"${question}" sorusunun bilimsel yanÄ±tÄ±nÄ± AkademikSoru'da buldum!`;
            if (navigator.share) {
                navigator.share({title: 'AkademikSoru', text: text, url: window.location.href});
            } else {
                copyLink();
            }
        }

        // Sayfa yÃ¼klendiÄŸinde oy ve kayÄ±t bilgisini al
        initVotesAndSave();
    </script>
</body>
</html>